---
title: "Dashboard de Logs (Dinámico)"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readxl)
library(tidyverse)
library(lubridate)
library(shiny)
library(plotly)
```


```{r}

datos<- read_excel("logs_curso.xlsx")

datos<- datos %>%
  mutate(
    Hora_dt = as.POSIXct(Hora, format = "%d/%m/%y, %H:%M:%S", tz = "Europe/Madrid"),
    Fecha   = as.Date(Hora_dt),
    Hour    = hour(Hora_dt),
    # Día de la semana con abreviaturas personalizadas
    Weekday_num = wday(Fecha, week_start = 1),  # lunes=1, domingo=7
    Weekday = factor(
      Weekday_num,
      levels = 1:7,
      labels = c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
      ordered = TRUE
    ),
    Origen = factor(Origen)
  )


datos <- datos %>%
  rename(
    hora            = Hora,
    usuario         = `Nombre completo del usuario`,
    usuario_afectado= `Usuario afectado`,
    contexto        = `Contexto del evento`,
    componente      = Componente,
    evento          = `Nombre evento`,
    descripcion     = Descripción,
    origen          = Origen,
    ip              = `Dirección IP`
  )


# Extraer nombres únicos de los alumnos
alumnos <- data.frame(
  usuario = unique(datos$usuario)
)


# Máximo de clics por día de la semana entre todos los alumnos
max_weekday <- datos %>%
  count(usuario, Weekday) %>%
  summarise(max_val = max(n)) %>%
  pull(max_val)

# Máximo de clics por hora entre todos los alumnos
max_hour <- datos %>%
  count(usuario, Hour) %>%
  summarise(max_val = max(n)) %>%
  pull(max_val)

```


```{r}
fecha_inicio <- as.Date("2025-09-01")
fecha_hoy <- Sys.Date()
max_dias <- as.integer(fecha_hoy - fecha_inicio + 1)

# Días distintos por alumno
dias_por_alumno <- datos %>%
  group_by(usuario) %>%
  summarise(dias_distintos = n_distinct(Fecha),
            clics = n(),
            .groups = "drop") %>%
  mutate(
    pct_dias = dias_distintos / max_dias * 100,
    clics_por_dia = clics / dias_distintos
  )

# Máximos
max_clics <- max(dias_por_alumno$clics)
max_clics_por_dia <- max(dias_por_alumno$clics_por_dia)

# Añadir porcentajes relativos
dias_por_alumno <- dias_por_alumno %>%
  mutate(
    pct_clics = clics / max_clics * 100,
    pct_clics_por_dia = clics_por_dia / max_clics_por_dia * 100
  )

```

Controles {.sidebar}
===============================

```{r}
selectInput("alumno", "Selecciona un alumno:",
            choices = sort(unique(datos$usuario)),
            selected = unique(datos$usuario)[1])

```


```{r}
# Filtrar métricas para el alumno seleccionado
metrics <- reactive({
  dias_por_alumno %>% filter(usuario == input$alumno)
})

# Filtrar datos para gráficos
datos_filtrados <- reactive({
  datos %>% filter(usuario == input$alumno)
})

```

Gráficos
============================

row
-----------------------------------------------------------------------

### Días distintos de conexión {.value-box}

```{r}
renderValueBox({
  # Calcular cuartiles globales (una sola vez, sobre todos los alumnos)
  qs <- quantile(dias_por_alumno$dias_distintos, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
  
  # Valor del alumno seleccionado
  valor <- metrics()$dias_distintos
  
  # Escala de colores
  color <- if (valor < qs[1]) {
    "red"
  } else if (valor < qs[2]) {
    "orange"
  } else if (valor < qs[3]) {
    "cyan"  
  } else {
    "green"
  }
  
  valueBox(
    value = valor,
    caption = "Días distintos de conexión",
    icon = "fa-calendar",
    color = color
  )
})

```


### % de días distintos {.gauge}
```{r}
renderGauge({
gauge(
  metrics()$pct_dias,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
  )
})
```

### Número de clics {.value-box}
```{r}
renderValueBox({
valueBox(
  value = metrics()$clics,
  caption = "Número de clics",
  icon = "fa-mouse-pointer"
  )
})  
```

### % de clics {.gauge}

```{r}
renderGauge({
gauge(
  metrics()$pct_clics,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
  )
})  
```

### Promedio clics/día {.value-box}

```{r}
renderValueBox({
valueBox(
  value = round(metrics()$clics_por_dia, 1),
  caption = "Promedio clics por día",
  icon = "fa-chart-line"
  )
})  
```


### % promedio clics/día {.gauge}
```{r}
renderGauge({
gauge(
  metrics()$pct_clics_por_dia,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
  )
})  
```




row
-----------------------------------------------------------------------

### Clics por día de la semana  {.full}

```{r}
renderPlot({
  ggplot(datos_filtrados(), aes(x = Weekday)) +
    geom_bar(fill = "steelblue") +
    scale_y_continuous(limits = c(0, max_weekday)) +
    theme_minimal() +
    labs(title = paste("Clics por día de la semana -", input$alumno),
         x = "Día", y = "Número de clics")
})
```

### Mapa de Calor{.full}

```{r}

renderPlotly({
  grid <- expand.grid(
    Weekday = factor(c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
                     levels = c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
                     ordered = TRUE),
    Hour = 0:23
  )
  
  datos_heatmap <- datos_filtrados() %>%
    count(Weekday, Hour)
  
  datos_heatmap <- grid %>%
    left_join(datos_heatmap, by = c("Weekday","Hour")) %>%
    mutate(n = replace_na(n, 0))
  
  plot_ly(
    data = datos_heatmap,
    x = ~Weekday,
    y = ~Hour,
    z = ~n,
    type = "heatmap",
    colors = colorRamp(c("white","darkgreen"))
  ) %>%
    layout(
      title = paste("Mapa de calor -", input$alumno),
      xaxis = list(title = "Día de la semana"),
      yaxis = list(title = "Hora del día", dtick = 1)
    )
})


```


### Clics por hora {.chart}

```{r}
renderPlot({
  ggplot(datos_filtrados(), aes(x = Hour)) +
    geom_bar(fill = "darkorange") +
    scale_x_continuous(breaks = 0:23) +
    scale_y_continuous(limits = c(0, max_hour)) +
    theme_minimal() +
    labs(title = paste("Clics por hora -", input$alumno),
         x = "Hora del día", y = "Número de clics")
})

```

Actividad
=======================

### Clics por día {.full}

```{r}


renderPlot({
  # Fechas de examen (puedes añadir más)
  examenes <- as.Date(c("2025-09-15", "2025-10-13", "2025-10-29", "2025-11-17", "2025-11-26"))
  
  # Secuencia completa de fechas en el intervalo
  all_dates <- tibble(Fecha = seq.Date(fecha_inicio, fecha_hoy, by = "day"))
  
  # Contar clics por día del alumno seleccionado
  clics_por_dia <- datos_filtrados() %>%
    count(Fecha)
  
  # Unir con todas las fechas y marcar Pruebas
  clics_por_dia <- all_dates %>%
    left_join(clics_por_dia, by = "Fecha") %>%
    mutate(n = replace_na(n, 0),
           es_examen = if_else(Fecha %in% examenes, "Pruebas", "Normal"))
  
  # Gráfico de barras con color según Pruebas
  ggplot(clics_por_dia, aes(x = Fecha, y = n, fill = es_examen)) +
    geom_col() +
    scale_fill_manual(values = c("Normal" = "steelblue", "Pruebas" = "red")) +
    theme_minimal() +
    labs(title = paste("Clics por día -", input$alumno),
         x = "Fecha", y = "Número de clics", fill = "Tipo de día")
})

```

