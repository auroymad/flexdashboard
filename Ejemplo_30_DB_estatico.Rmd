---
title: "Dashboard de Logs (Estático)"                 # Título del dashboard
output: 
  flexdashboard::flex_dashboard:
    orientation: rows                                 # Distribución por filas
    source_code: embed                                # Botón para ver el código fuente
    vertical_layout: fill                             # Ajuste vertical automático
---


```{r setup, include=FALSE}
library(flexdashboard)                                # Componentes del dashboard
library(readxl)                                       # Lectura de Excel
library(tidyverse)                                    # Manipulación de datos
library(lubridate)                                    # Fechas y horas

```


```{r}

## Lectura y preprocesado del Excel

datos <- read_excel("logs_curso.xlsx")                # Cargar logs

datos <- datos %>%
  mutate(
    Hora_dt = as.POSIXct(Hora,                        # Convertir a fecha-hora real
                         format = "%d/%m/%y, %H:%M:%S",
                         tz = "Europe/Madrid"),
    Fecha   = as.Date(Hora_dt),                       # Extraer fecha
    Hour    = hour(Hora_dt),                          # Extraer hora (0–23)

    # Día de la semana (lunes=1)
    Weekday_num = wday(Fecha, week_start = 1),
    Weekday = factor(
      Weekday_num,
      levels = 1:7,
      labels = c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
      ordered = TRUE
    ),

    Origen = factor(Origen)                           # Convertir a factor
  )

# Renombrar columnas para trabajar más cómodo
datos <- datos %>%
  rename(
    hora             = Hora,
    usuario          = `Nombre completo del usuario`,
    usuario_afectado = `Usuario afectado`,
    contexto         = `Contexto del evento`,
    componente       = Componente,
    evento           = `Nombre evento`,
    descripcion      = Descripción,
    origen           = Origen,
    ip               = `Dirección IP`
  )

# Lista de alumnos únicos
alumnos <- data.frame(usuario = unique(datos$usuario))

```


```{r}

## Cálculo de métricas globales

fecha_inicio <- as.Date("2025-09-01")                 # Inicio del curso
fecha_hoy <- Sys.Date()                               # Fecha actual
max_dias <- as.integer(fecha_hoy - fecha_inicio + 1)  # Días posibles

# Métricas por alumno
dias_por_alumno <- datos %>%
  group_by(usuario) %>%
  summarise(
    dias_distintos = n_distinct(Fecha),               # Días con actividad
    clics = n(),                                      # Total de clics
    .groups = "drop"
  ) %>%
  mutate(
    pct_dias = dias_distintos / max_dias * 100,       # % de días activos
    clics_por_dia = clics / dias_distintos            # Media de clics/día
  )

# Máximos globales para normalizar
max_clics <- max(dias_por_alumno$clics)
max_clics_por_dia <- max(dias_por_alumno$clics_por_dia)

# Añadir porcentajes relativos
dias_por_alumno <- dias_por_alumno %>%
  mutate(
    pct_clics = clics / max_clics * 100,
    pct_clics_por_dia = clics_por_dia / max_clics_por_dia * 100
  )

```

```{r}
# Selección estática de un alumno (simulando selectInput)
n <- 1  # Elegir alumno (simulación)
alumno <- alumnos[n, "usuario"]

# Filtrar métricas para ese alumno
metrics <- dias_por_alumno %>% filter(usuario == alumno)    # Métricas del alumno
```

row
-----------------------------------------------------------------------

### Días distintos de conexión {.value-box}

```{r}
# Calcular cuartiles globales
qs <- quantile(dias_por_alumno$dias_distintos, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)

# Seleccionar color según el valor del alumno
valor <- metrics$dias_distintos
color <- if (valor < qs[1]) {
  "red"
} else if (valor < qs[2]) {
  "orange"
} else if (valor < qs[3]) {
  "cyan"   
} else {
  "green"
}

# ValueBox con color dinámico
valueBox(
  value = valor,
  caption = "Días distintos de conexión",
  icon = "fa-calendar",
  color = color
)

```


### % de días distintos {.gauge}
```{r}
gauge(
  metrics$pct_dias,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
)

```

### Número de clics {.value-box}
```{r}
valueBox(
  value = metrics$clics,
  caption = "Número de clics",
  icon = "fa-mouse-pointer"
)

```

### % de clics {.gauge}

```{r}
gauge(
  metrics$pct_clics,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
)

```

### Promedio clics/día {.value-box}

```{r}
valueBox(
  value = round(metrics$clics_por_dia, 1),
  caption = "Promedio clics por día",
  icon = "fa-chart-line"
)

```


### % promedio clics/día {.gauge}
```{r}
gauge(
  metrics$pct_clics_por_dia,
  min = 0, max = 100,
  label = "% sobre máximo",
  gaugeSectors(success = c(80, 100), warning = c(50, 79), danger = c(0, 49))
)

```




row
-----------------------------------------------------------------------

### Clics por día de la semana  {.full}

```{r}
ggplot(datos %>% filter(usuario == alumno), aes(x = Weekday)) +
  geom_bar(fill = "steelblue") +
  theme_minimal() +
  labs(title = paste("Clics por día de la semana -", alumno),
       x = "Día", y = "Número de clics")

```

### Mapa de calor  {.full}

```{r}
library(plotly)

# Crear el tablero completo
grid <- expand.grid(
  Weekday = factor(c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
                   levels = c("Lun","Mar","Mie","Jue","Vie","Sab","Dom"),
                   ordered = TRUE),
  Hour = 0:23
)

# Contar clics por día-hora para el alumno
datos_heatmap <- datos %>%
  filter(usuario == alumno) %>%
  count(Weekday, Hour)

# Unir con el grid para asegurar las 168 casillas
datos_heatmap <- grid %>%
  left_join(datos_heatmap, by = c("Weekday","Hour")) %>%
  mutate(n = replace_na(n, 0))

# Crear el heatmap interactivo
plot_ly(
  data = datos_heatmap,
  x = ~Weekday,
  y = ~Hour,
  z = ~n,
  type = "heatmap",
  colors = colorRamp(c("white","darkgreen"))
) %>%
  layout(
    title = paste("Mapa de calor -", alumno),
    xaxis = list(title = "Día de la semana"),
    yaxis = list(title = "Hora del día", dtick = 1)
  )

```


### Clics por hora {.chart}

```{r}
ggplot(datos %>% filter(usuario == alumno), aes(x = Hour)) +
  geom_bar(fill = "darkorange") +
  scale_x_continuous(breaks = 0:23) +
  theme_minimal() +
  labs(title = paste("Clics por hora -", alumno),
       x = "Hora del día", y = "Número de clics")

```

